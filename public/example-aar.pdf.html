<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThreatRecon - Example After Action Report</title>
    <style>
        @media print {
            body { margin: 0; }
            .no-print { display: none; }
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
        }
        .header {
            text-align: center;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2563eb;
            margin: 0;
            font-size: 2.5em;
        }
        .header .subtitle {
            color: #666;
            font-size: 1.2em;
            margin-top: 10px;
        }
        .session-info {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .session-info h2 {
            color: #1e40af;
            margin-top: 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .info-item {
            display: flex;
            flex-direction: column;
        }
        .info-label {
            font-weight: bold;
            color: #374151;
            font-size: 0.9em;
        }
        .info-value {
            color: #6b7280;
            margin-top: 5px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            color: #1e40af;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
        .timeline-item {
            background: #f9fafb;
            border-left: 4px solid #2563eb;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }
        .timeline-time {
            font-weight: bold;
            color: #374151;
            font-size: 0.9em;
        }
        .timeline-content {
            margin-top: 8px;
            color: #4b5563;
        }
        .timeline-type {
            display: inline-block;
            background: #2563eb;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 10px;
        }
        .timeline-type.inject {
            background: #dc2626;
        }
        .timeline-type.decision {
            background: #059669;
        }
        .timeline-type.facilitator {
            background: #7c3aed;
        }
        .scoring-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .score-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
        }
        .score-item h3 {
            margin: 0 0 10px 0;
            color: #1e40af;
        }
        .score-value {
            font-size: 2em;
            font-weight: bold;
            color: #059669;
        }
        .score-details {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 10px;
        }
        .gap-item {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }
        .gap-severity {
            display: inline-block;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 10px;
        }
        .remediation-item {
            background: #ecfdf5;
            border-left: 4px solid #059669;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }
        .remediation-priority {
            display: inline-block;
            background: #059669;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 10px;
        }
        .compliance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .compliance-item {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .compliance-item h3 {
            margin: 0 0 10px 0;
            color: #1e40af;
        }
        .compliance-status {
            font-weight: bold;
            color: #059669;
        }
        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
            text-align: center;
            color: #6b7280;
            font-size: 0.9em;
        }
        .signature-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.8em;
        }
        .print-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .print-button:hover {
            background: #1d4ed8;
        }
    </style>
</head>
<body>
    <button class="print-button no-print" onclick="window.print()">Print PDF</button>

    <div class="header">
        <h1>ThreatRecon</h1>
        <div class="subtitle">After Action Report</div>
    </div>

    <div class="session-info">
        <h2>Session Information</h2>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Session ID</div>
                <div class="info-value" id="report-session-id">example-session-2024</div>
            </div>
            <div class="info-item">
                <div class="info-label">Scenario</div>
                <div class="info-value" id="report-scenario">Ransomware Attack Simulation</div>
            </div>
            <div class="info-item">
                <div class="info-label">Duration</div>
                <div class="info-value" id="report-duration">30 minutes</div>
            </div>
            <div class="info-item">
                <div class="info-label">Participants</div>
                <div class="info-value">5 roles</div>
            </div>
            <div class="info-item">
                <div class="info-label">Generated</div>
                <div class="info-value" id="report-generated">October 25, 2024</div>
            </div>
            <div class="info-item">
                <div class="info-label">Overall Score</div>
                <div class="info-value">82/100</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Participant Roles</h2>
        <ul>
            <li><strong>IR Lead</strong> - Security Team Lead</li>
            <li><strong>Network Admin</strong> - Network Operations</li>
            <li><strong>Legal Counsel</strong> - Legal Department</li>
            <li><strong>Exec Sponsor</strong> - Executive Team</li>
            <li><strong>PR/Comms</strong> - Communications Team</li>
        </ul>
    </div>

    <div class="section">
        <h2>Drill Timeline</h2>
        
        <div class="timeline-item">
            <div class="timeline-time">06:03:00</div>
            <div class="timeline-content">
                <span class="timeline-type inject">INJECT</span>
                <strong>Critical:</strong> Suspicious outbound traffic detected from PAYMENT_GATEWAY_SERVICE. Multiple encrypted connections to external IPs.
                <br><em>Target: IR Lead, Network Admin</em>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-time">06:07:00</div>
            <div class="timeline-content">
                <span class="timeline-type decision">DECISION</span>
                <strong>IR Lead:</strong> Initiated incident response protocol
                <br><em>Rationale: Following standard IR procedures for suspicious network activity</em>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-time">06:07:30</div>
            <div class="timeline-content">
                <span class="timeline-type decision">DECISION</span>
                <strong>Network Admin:</strong> Isolated PAYMENT_GATEWAY_SERVICE from network
                <br><em>Rationale: Preventive measure to contain potential threat</em>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-time">06:10:00</div>
            <div class="timeline-content">
                <span class="timeline-type inject">INJECT</span>
                <strong>Warning:</strong> Fake journalist from TechNews Daily requests comment on 'rumored data breach affecting customer payment systems'
                <br><em>Target: PR/Comms, Exec Sponsor</em>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-time">06:12:00</div>
            <div class="timeline-content">
                <span class="timeline-type decision">DECISION</span>
                <strong>PR/Comms:</strong> Prepared 'no comment' statement
                <br><em>Rationale: Following media policy during active investigation</em>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-time">06:15:00</div>
            <div class="timeline-content">
                <span class="timeline-type inject">INJECT</span>
                <strong>Critical:</strong> CFO receives sophisticated wire fraud attempt via email impersonating CEO. Request for urgent $50,000 transfer to 'emergency vendor account'
                <br><em>Target: Exec Sponsor, Legal Counsel</em>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-time">06:18:00</div>
            <div class="timeline-content">
                <span class="timeline-type decision">DECISION</span>
                <strong>Exec Sponsor:</strong> Verified CEO identity through separate channel
                <br><em>Rationale: Following financial authorization protocols</em>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-time">06:20:00</div>
            <div class="timeline-content">
                <span class="timeline-type facilitator">FACILITATOR</span>
                <strong>Escalated severity to CRITICAL</strong>
                <br><em>Reason: Multiple attack vectors detected simultaneously</em>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-time">06:22:00</div>
            <div class="timeline-content">
                <span class="timeline-type inject">INJECT</span>
                <strong>Critical:</strong> Regulatory notification required within 72 hours. Legal team needs immediate incident assessment for compliance reporting.
                <br><em>Target: Legal Counsel, Exec Sponsor</em>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-time">06:25:00</div>
            <div class="timeline-content">
                <span class="timeline-type decision">DECISION</span>
                <strong>Legal Counsel:</strong> Initiated regulatory notification process
                <br><em>Rationale: Compliance with data breach notification requirements</em>
            </div>
        </div>

        <div class="timeline-item">
            <div class="timeline-time">06:30:00</div>
            <div class="timeline-content">
                <span class="timeline-type facilitator">FACILITATOR</span>
                <strong>Ended session</strong>
                <br><em>Reason: Sufficient data collected for assessment</em>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Performance Scoring</h2>
        <div class="scoring-grid">
            <div class="score-item">
                <h3>Technical Response</h3>
                <div class="score-value">85%</div>
                <div class="score-details">
                    • Quick incident detection and analysis<br>
                    • Effective containment measures<br>
                    • Good forensic evidence preservation<br>
                    • System restoration procedures followed
                </div>
            </div>
            <div class="score-item">
                <h3>Legal & Compliance</h3>
                <div class="score-value">92%</div>
                <div class="score-details">
                    • Timely regulatory notification initiation<br>
                    • Proper legal counsel engagement<br>
                    • Evidence chain of custody maintained<br>
                    • Policy adherence demonstrated
                </div>
            </div>
            <div class="score-item">
                <h3>Communication</h3>
                <div class="score-value">78%</div>
                <div class="score-details">
                    • Appropriate media response strategy<br>
                    • Internal stakeholder communication<br>
                    • Message consistency maintained<br>
                    • Crisis communication plan activated
                </div>
            </div>
            <div class="score-item">
                <h3>Executive Decision Making</h3>
                <div class="score-value">88%</div>
                <div class="score-details">
                    • Strategic decisions made promptly<br>
                    • Resource allocation appropriate<br>
                    • Risk assessment conducted<br>
                    • Leadership presence maintained
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Gaps Identified</h2>
        
        <div class="gap-item">
            <span class="gap-severity">MEDIUM</span>
            <strong>Technical:</strong> Network monitoring could be enhanced with automated threat detection
            <br><em>Recommendation: Implement SIEM with behavioral analytics</em>
        </div>

        <div class="gap-item">
            <span class="gap-severity">LOW</span>
            <strong>Communication:</strong> Media response templates could be more comprehensive
            <br><em>Recommendation: Develop scenario-specific communication templates</em>
        </div>

        <div class="gap-item">
            <span class="gap-severity">MEDIUM</span>
            <strong>Process:</strong> Financial authorization verification process needs strengthening
            <br><em>Recommendation: Implement multi-factor verification for wire transfers</em>
        </div>
    </div>

    <div class="section">
        <h2>Remediation Plan</h2>
        
        <div class="remediation-item">
            <span class="remediation-priority">HIGH</span>
            <strong>Enhance network monitoring with automated threat detection</strong>
            <br><em>Timeline: 30 days | Owner: Network Admin | Status: Planned</em>
        </div>

        <div class="remediation-item">
            <span class="remediation-priority">HIGH</span>
            <strong>Implement multi-factor verification for financial transactions</strong>
            <br><em>Timeline: 14 days | Owner: Exec Sponsor | Status: Planned</em>
        </div>

        <div class="remediation-item">
            <span class="remediation-priority">MEDIUM</span>
            <strong>Develop comprehensive media response templates</strong>
            <br><em>Timeline: 60 days | Owner: PR/Comms | Status: Planned</em>
        </div>

        <div class="remediation-item">
            <span class="remediation-priority">MEDIUM</span>
            <strong>Conduct tabletop exercise quarterly</strong>
            <br><em>Timeline: 90 days | Owner: IR Lead | Status: Planned</em>
        </div>
    </div>

    <div class="section">
        <h2>Compliance Alignment</h2>
        <div class="compliance-grid">
            <div class="compliance-item">
                <h3>NIST 800-61</h3>
                <div class="compliance-status">Met</div>
                <div style="margin-top: 10px; font-size: 0.9em;">
                    Detection ✓<br>
                    Analysis ✓<br>
                    Containment ✓<br>
                    Recovery ✓
                </div>
            </div>
            <div class="compliance-item">
                <h3>SOC 2</h3>
                <div class="compliance-status">Met</div>
                <div style="margin-top: 10px; font-size: 0.9em;">
                    Security ✓<br>
                    Availability ✓<br>
                    Confidentiality ✓<br>
                    Privacy ✓
                </div>
            </div>
            <div class="compliance-item">
                <h3>ISO 27035</h3>
                <div class="compliance-status">Met</div>
                <div style="margin-top: 10px; font-size: 0.9em;">
                    Incident Management ✓<br>
                    Response Procedures ✓<br>
                    Communication ✓<br>
                    Documentation ✓
                </div>
            </div>
        </div>
    </div>

    <div class="signature-info">
        <strong>Cryptographic Signature:</strong><br>
        Hash: a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456<br>
        Signing Key: tr-public-hosted-v1<br>
        Generated: 2024-10-25T06:30:00.000Z
    </div>

    <div class="footer">
        <p>This report was generated by ThreatRecon Breach Drill Automation Platform</p>
        <p>For sensitive drills, deploy ThreatRecon on-premise using our Docker Compose bundle</p>
        <p>© 2024 ThreatRecon. Built for security teams who take readiness seriously.</p>
    </div>

    <script>
    (async function () {
        // grab sessionId from the query string
        const m = location.search.match(/[?&]sessionId=([^&]+)/);
        if (!m) return; // if no sessionId, leave the static demo values
        const sessionId = decodeURIComponent(m[1]);

        try {
            const res = await fetch(`/api/sessions/${sessionId}`);
            if (!res.ok) {
                console.error('Could not load session data for report');
                return;
            }

            const data = await res.json();
            const { session, participants, events } = data;

            // fill top summary
            const sessionIdEl = document.getElementById('report-session-id');
            const scenarioEl = document.getElementById('report-scenario');
            const generatedEl = document.getElementById('report-generated');
            
            if (sessionIdEl) sessionIdEl.textContent = session.id;
            if (scenarioEl) scenarioEl.textContent = session.scenario_id || 'Custom Incident Simulation';
            if (generatedEl) generatedEl.textContent = new Date().toLocaleString();

            // naive duration: now - session.created_at in minutes
            if (session.created_at) {
                const start = new Date(session.created_at);
                const now = new Date();
                const mins = Math.max(1, Math.round((now - start) / 60000));
                const durationEl = document.getElementById('report-duration');
                if (durationEl) durationEl.textContent = mins + ' minutes';
            }

            // fill participants list if element exists
            const pList = document.getElementById('report-participants');
            if (pList) {
                pList.innerHTML = '';
                participants.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.role} - ${p.name}`;
                    pList.appendChild(li);
                });
            }

            // fill timeline if element exists
            const tDiv = document.getElementById('report-timeline');
            if (tDiv) {
                tDiv.innerHTML = '';
                events.forEach(ev => {
                    const block = document.createElement('div');
                    block.style.borderLeft = '4px solid ' + (
                        ev.type === 'inject'    ? '#22d3ee' :
                        ev.type === 'decision'  ? '#a3e635' :
                        '#60a5fa'
                    );
                    block.style.padding = '8px 12px';
                    block.style.marginBottom = '12px';
                    block.style.background = '#f8fafc';
                    block.style.border = '1px solid #cbd5e1';
                    block.style.borderRadius = '6px';
                    block.style.fontFamily = 'system-ui, sans-serif';
                    const ts = new Date(ev.ts || Date.now()).toLocaleString();
                    block.innerHTML = `
                        <div style="font-size:12px;color:#475569;margin-bottom:4px;">
                            [${ts}] ${ev.type.toUpperCase()} ${ev.severity ? '('+ev.severity+')' : ''} ${ev.author ? '— '+ev.author : ''}
                        </div>
                        <div style="font-size:14px;color:#0f172a;">${ev.message}</div>
                    `;
                    tDiv.appendChild(block);
                });
            }
        } catch (err) {
            console.error('Failed to load session data:', err);
        }
    })();
    </script>
</body>
</html>
